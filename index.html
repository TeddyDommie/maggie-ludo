<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ludo — Online (Demo)</title>
  <link rel="stylesheet" href="index.css" />
  <!-- Firebase (optional) - v9 modular CDN -->
  <script type="module" id="firebase-modules" defer>
    // If you plan to use Firebase, paste your config into the placeholder below
    // and set `useFirebase = true` in the main script (or call connectFirebase(config)).
    // Example: const firebaseConfig = { apiKey: "...", authDomain: "...", databaseURL: "...", projectId: "...", ... };
  </script>
</head>
<body>
  <div id="app" class="wrap wood-bg">
    <header class="topbar">
      <div class="logo">LUDO • Challenge & Play</div>
      <div class="sub">Login/Register • Create rooms • Dice • Real-time (Firebase optional)</div>
    </header>

    <main class="frame">
      <!-- LEFT: Auth + rooms -->
      <aside class="panel left">
        <section id="authPanel" class="card">
          <div id="welcome" class="muted">Welcome — please register or login</div>
          <label>Username</label>
          <input id="username" placeholder="Your name" autocomplete="username" />
          <label>Password</label>
          <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
          <div class="row gap-sm">
            <button id="btnRegister" class="btn ghost">Register</button>
            <button id="btnLogin" class="btn primary">Login</button>
          </div>
          <div class="muted stats">Wins: <span id="wins">0</span> • Games: <span id="total">0</span></div>
        </section>

        <section id="roomsPanel" class="card">
          <div class="row gap-sm">
            <button id="createRoom" class="btn primary">Create Room</button>
            <input id="joinCode" placeholder="Room code (AB12CD)" />
            <button id="joinRoom" class="btn ghost">Join</button>
          </div>
          <div id="roomList" class="room-list"></div>
          <div class="muted small">Tip: For real online play, add Firebase config (see top of file and README).</div>
        </section>

        <section class="card">
          <label>Firebase config (optional)</label>
          <textarea id="fbConfig" placeholder='Paste your Firebase config JSON and press Connect' spellcheck="false"></textarea>
          <div class="row gap-sm">
            <button id="connectFb" class="btn ghost">Connect</button>
            <button id="disconnectFb" class="btn ghost">Disconnect</button>
            <div id="fbStatus" class="muted small">Not connected</div>
          </div>
        </section>
      </aside>

      <!-- RIGHT: Board & chat -->
      <section class="panel play-area">
        <div id="statusMsg" class="statusMsg center">Not in room</div>

        <div class="board-chat">
          <div id="boardWrap" class="board card">
            <!-- Ludo board canvas -->
            <div id="ludoBoard" class="ludo">
              <!-- drawn by JS -->
            </div>

            <!-- dice floating on board -->
            <div class="dice-wrap">
              <div id="orbitDice" class="dice orbit"><div id="diceFace" class="dots">⚀</div></div>
            </div>
          </div>

          <div class="card chat">
            <div id="messages" class="messages"></div>
            <div class="chat-input">
              <input id="chatText" placeholder="Message..." />
              <button id="sendMsg" class="btn primary">Send</button>
            </div>
          </div>
        </div>

        <div class="controls row between">
          <div class="row gap-sm left">
            <div id="gameStatus" class="muted">Not in room</div>
            <button id="rollDice" class="btn primary">Roll Dice</button>
            <button id="endTurn" class="btn ghost">End Turn</button>
            <button id="resetLocal" class="btn ghost">Reset</button>
          </div>
          <div class="muted small">Share room code to let friends join</div>
        </div>
      </section>
    </main>

    <footer class="footer muted small">Demo Ludo • Wooden theme • Replace Firebase config for realtime sync</footer>
  </div>

  <script>
  // =======================
  // Ludo demo with optional Firebase realtime support
  // - Save as index.html and put index.css next to it
  // - To enable online multiplayer: paste Firebase config JSON in the textarea on the left and press Connect
  // =======================

  const $ = id => document.getElementById(id);

  // Local storage helpers
  function loadUsers(){ return JSON.parse(localStorage.getItem('ludo_users')||'{}'); }
  function saveUsers(u){ localStorage.setItem('ludo_users', JSON.stringify(u)); }
  function loadRooms(){ return JSON.parse(localStorage.getItem('ludo_rooms')||'{}'); }
  function saveRooms(r){ localStorage.setItem('ludo_rooms', JSON.stringify(r)); }

  // App state
  let currentRoom = null;
  let firebaseApp = null;
  let useFirebase = false;
  let db = null; // realtime DB reference (if connected)
  const localNameKey = 'ludo_current';

  // ========== UI helpers ==========
  function showUserInfo(){
    const cur = localStorage.getItem(localNameKey);
    if(cur){
      const users = loadUsers();
      const u = users[cur] || {wins:0,total:0};
      $('welcome').innerText = `Hi ${cur}!`;
      $('wins').innerText = u.wins || 0;
      $('total').innerText = u.total || 0;
    } else {
      $('welcome').innerText = 'Welcome — please register or login';
      $('wins').innerText = 0; $('total').innerText = 0;
    }
  }

  $('btnRegister').onclick = ()=>{
    const name = $('username').value.trim(), pass = $('password').value;
    if(!name||!pass) return alert('Enter username & password');
    const users = loadUsers();
    if(users[name]) return alert('Username exists');
    users[name] = {pass,wins:0,total:0};
    saveUsers(users);
    localStorage.setItem(localNameKey, name);
    showUserInfo();
    renderRoomList();
    alert('Registered & logged in');
  };

  $('btnLogin').onclick = ()=>{
    const name = $('username').value.trim(), pass = $('password').value;
    const users = loadUsers();
    if(!users[name] || users[name].pass !== pass) return alert('Invalid credentials');
    localStorage.setItem(localNameKey, name);
    showUserInfo();
    renderRoomList();
    alert('Logged in');
  };

  $('resetLocal').onclick = ()=>{
    if(!confirm('Clear local data (rooms + users + current)?')) return;
    localStorage.removeItem('ludo_rooms');
    localStorage.removeItem('ludo_users');
    localStorage.removeItem(localNameKey);
    location.reload();
  };

  // ========== Rooms (local or Firebase) ==========
  function generateRoomCode(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }

  function renderRoomList(){
    const list = $('roomList'); list.innerHTML = '';
    const rooms = loadRooms();
    for(const code in rooms){
      const r = rooms[code];
      const el = document.createElement('div');
      el.className = 'room';
      el.innerHTML = `<div><strong>${code}</strong> — ${r.players.length}/2</div>
                      <div class="row gap-sm">
                        <button class="btn ghost joinBtn" data-code="${code}">Join</button>
                        <button class="btn ghost spectateBtn" data-code="${code}">Enter</button>
                      </div>`;
      list.appendChild(el);
    }
    list.querySelectorAll('.joinBtn').forEach(b => b.onclick = e => joinRoom(b.dataset.code));
    list.querySelectorAll('.spectateBtn').forEach(b => b.onclick = e => enterRoom(b.dataset.code));
  }

  $('createRoom').onclick = async ()=>{
    const cur = localStorage.getItem(localNameKey);
    if(!cur) return alert('Login first');
    const code = generateRoomCode();
    const rooms = loadRooms();
    rooms[code] = { players: [cur], chat: [], state: createInitialState() };
    saveRooms(rooms);
    renderRoomList();
    enterRoom(code);
    if(useFirebase) await pushRoomToFirebase(code, rooms[code]);
  };

  $('joinRoom').onclick = ()=> {
    const code = $('joinCode').value.trim().toUpperCase();
    if(!code) return alert('Enter code');
    joinRoom(code);
  };

  async function joinRoom(code){
    const cur = localStorage.getItem(localNameKey);
    if(!cur) return alert('Login first');
    let rooms = loadRooms();
    if(!rooms[code]){
      alert('Room not found (local). If using Firebase, press Connect first.');
      return;
    }
    const r = rooms[code];
    if(!r.players.includes(cur)){
      if(r.players.length >= 2) return alert('Room full');
      r.players.push(cur);
    }
    saveRooms(rooms);
    renderRoomList();
    enterRoom(code);
    if(useFirebase) await pushRoomToFirebase(code, r);
  }

  function enterRoom(code){
    currentRoom = code;
    $('statusMsg').innerText = `Room ${code} — Players: ${loadRooms()[code].players.join(', ')}`;
    $('gameStatus').innerText = `In room ${code}`;
    renderChat();
    drawBoard();
    // if firebase connected, subscribe to updates
    if(useFirebase) subscribeRoom(code);
  }

  // ========== Chat (local) ==========
  $('sendMsg').onclick = ()=>{
    const txt = $('chatText').value.trim();
    if(!txt || !currentRoom) return;
    const cur = localStorage.getItem(localNameKey);
    const rooms = loadRooms();
    rooms[currentRoom].chat.push({from:cur, text:txt, t:Date.now()});
    saveRooms(rooms);
    $('chatText').value = '';
    renderChat();
    if(useFirebase) pushChatToFirebase(currentRoom, rooms[currentRoom].chat);
  };

  function renderChat(){
    const msgs = $('messages'); msgs.innerHTML = '';
    if(!currentRoom) return;
    const rooms = loadRooms(); if(!rooms[currentRoom]) return;
    rooms[currentRoom].chat.forEach(m=>{
      const d = document.createElement('div');
      d.className = 'msg ' + ((m.from === localStorage.getItem(localNameKey)) ? 'me' : 'them');
      d.textContent = (m.from ? (m.from + ': ') : '') + m.text;
      msgs.appendChild(d);
    });
    msgs.scrollTop = msgs.scrollHeight;
  }

  // ============================
  // Ludo state & rendering (simplified)
  // - visual board with four bases
  // - tokens displayed as circles in bases and central progress
  // - clicking a token moves based on dice (very simplified)
  // ============================

  function createInitialState(){
    return {
      players: [],
      turnIndex: 0,
      dice: 0,
      pathLength: 52,
      finishLength: 6,
      tokens: {}, // tokens[player] = [-1,-1,-1,-1]
      lastAction: ''
    };
  }

  function ensureState(){
    const rooms = loadRooms();
    if(!currentRoom) return null;
    const r = rooms[currentRoom];
    if(!r.state) r.state = createInitialState();
    r.state.players = r.state.players.length ? r.state.players : r.players.slice(0,2);
    r.state.players.forEach(p => { if(!r.state.tokens[p]) r.state.tokens[p] = [-1,-1,-1,-1]; });
    saveRooms(rooms);
    return r.state;
  }

  // Board DOM
  const boardElem = $('ludoBoard');
  function drawBoard(){
    boardElem.innerHTML = '';
    // Wooden textured quadrants - use CSS classes for visuals
    const state = ensureState();
    // Four bases visuals
    const bases = ['green','red','yellow','blue'];
    bases.forEach((c, idx)=>{
      const base = document.createElement('div');
      base.className = `base base-${c}`;
      const holder = document.createElement('div'); holder.className = 'base-holes';
      for(let i=0;i<4;i++){
        const hole = document.createElement('div'); hole.className='hole';
        // show token if player's token is home and player occupies this base
        const players = state ? state.players : [];
        const playerName = players[idx];
        if(playerName){
          const tPositions = state.tokens[playerName];
          if(tPositions && tPositions[i] === -1){
            const token = document.createElement('div'); token.className = `token p${idx+1}`;
            token.title = `${playerName} token ${i+1}`;
            token.onclick = ()=> attemptMove(playerName, i);
            hole.appendChild(token);
          }
        }
        holder.appendChild(hole);
      }
      base.appendChild(holder);
      boardElem.appendChild(base);
    });

    // Center progress panel (simple)
    const center = document.createElement('div'); center.className = 'center-panel';
    const st = state || createInitialState();
    (st.players || []).forEach((p,idx)=>{
      const row = document.createElement('div'); row.className = 'center-row';
      const name = document.createElement('div'); name.className='center-name'; name.textContent = p;
      const tokens = document.createElement('div'); tokens.className='center-tokens';
      st.tokens[p].forEach((pos,tidx)=>{
        const t = document.createElement('div'); t.className='token-mini';
        if(pos === -1) t.textContent = '•';
        else if(pos >= 100) t.textContent = '🏁';
        else t.textContent = ((pos%st.pathLength)+1);
        t.onclick = ()=> attemptMove(p,tidx);
        tokens.appendChild(t);
      });
      row.appendChild(name);
      row.appendChild(tokens);
      center.appendChild(row);
    });
    boardElem.appendChild(center);

    // update dice face
    const diceFace = $('diceFace');
    const s = ensureState();
    diceFace.innerText = ['⚀','⚁','⚂','⚃','⚄','⚅'][ (s && (s.dice-1) >=0)? s.dice-1 : 0 ];
  }

  function diceToUnicode(n){ return ['⚀','⚁','⚂','⚃','⚄','⚅'][n-1] || '⚀'; }

  // Roll dice (sync to firebase or local)
  $('rollDice').onclick = ()=>{
    const state = ensureState();
    if(!state) return alert('Enter a room first');
    const cur = localStorage.getItem(localNameKey);
    if(!state.players.includes(cur)) return alert('You are not a player in this room');
    if(state.players[state.turnIndex] !== cur) return alert('Not your turn');
    const v = Math.floor(Math.random()*6)+1;
    state.dice = v;
    state.lastAction = `${cur} rolled ${v}`;
    saveStateToRoom(state);
    animateDice(v);
    drawBoard();
    if(useFirebase) pushStateToFirebase(currentRoom, state);
  };

  function animateDice(value){
    $('diceFace').innerText = diceToUnicode(value);
    const d = $('orbitDice');
    d.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.15)' }, { transform: 'scale(1)' }], { duration: 420 });
  }

  function attemptMove(player, tokenIndex){
    const state = ensureState();
    if(!state) return;
    const cur = localStorage.getItem(localNameKey);
    if(state.players[state.turnIndex] !== cur) return alert('Not your turn');
    if(player !== cur) return alert('You can only move your tokens');
    if(!state.dice || state.dice < 1) return alert('Roll the dice first');
    const pos = state.tokens[player][tokenIndex];
    if(pos === -1){
      if(state.dice !== 6) return alert('Need a 6 to enter');
      state.tokens[player][tokenIndex] = 0;
    } else if(pos >= 100){
      return alert('Token already finished');
    } else {
      state.tokens[player][tokenIndex] += state.dice;
      if(state.tokens[player][tokenIndex] >= state.pathLength + state.finishLength){
        state.tokens[player][tokenIndex] = 100 + tokenIndex;
      }
    }

    // capture simple rule
    const myPos = state.tokens[player][tokenIndex];
    state.players.forEach(other=>{
      if(other === player) return;
      state.tokens[other].forEach((op, oi)=>{
        if(op >= 0 && op < 100 && myPos >= 0 && myPos < 100 && (op % state.pathLength) === (myPos % state.pathLength)){
          state.tokens[other][oi] = -1;
          // add chat message about capture
          state.chat.push({from:'SYSTEM', text: `${player} captured ${other}'s token!`, t:Date.now()});
        }
      });
    });

    // advance turn except when dice 6
    if(state.dice !== 6) state.turnIndex = (state.turnIndex + 1) % state.players.length;
    state.lastAction = `${player} moved token ${tokenIndex+1}`;
    state.dice = 0;
    saveStateToRoom(state);
    drawBoard();
    renderChat();
    if(useFirebase) pushStateToFirebase(currentRoom, state);

    // check win
    if(state.tokens[player].every(x=>x>=100)) announceWin(player);
  }

  function saveStateToRoom(state){
    const rooms = loadRooms();
    if(!currentRoom) return;
    rooms[currentRoom].state = state;
    saveRooms(rooms);
  }

  function announceWin(player){
    const rooms = loadRooms();
    if(!currentRoom) return;
    const r = rooms[currentRoom];
    r.chat.push({from:'SYSTEM', text: `🏆 ${player} has won!`, t:Date.now()});
    // update users
    const users = loadUsers();
    r.players.forEach(p=>{
      if(!users[p]) users[p] = {pass:'', wins:0, total:0};
      users[p].total = (users[p].total||0) + 1;
      if(p === player) users[p].wins = (users[p].wins||0) + 1;
    });
    saveUsers(users);
    showUserInfo();
    // reset room state for rematch
    r.state = createInitialState();
    r.state.players = r.players.slice(0,2);
    saveRooms(rooms);
    renderRoomList();
    drawBoard();
    renderChat();
    if(useFirebase) pushRoomToFirebase(currentRoom, r);
  }

  // ========== State & Sync helpers ==========
  function saveRoomsAndUpdateUI(){ saveRooms(loadRooms()); renderRoomList(); renderChat(); drawBoard(); }

  // ========== Firebase integration (optional) ==========
  // We'll use Firebase Realtime Database via CDN modular SDK if user supplies config
  async function connectFirebaseFromConfig(config){
    try {
      // import modules dynamically
      const mod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
      // Use compat build for simplicity in this demo
      // NOTE: For production use modular SDK properly
      const firebase = window.firebase;
      if(!firebase){
        alert('Firebase loaded; please ensure network access.');
      }
      // initialize app and database
      const app = firebase.initializeApp(config);
      firebaseApp = app;
      db = firebase.database();
      useFirebase = true;
      $('fbStatus').innerText = 'Connected';
      // Start listening top-level rooms node and keep local rooms synced
      db.ref('ludo_rooms').on('value', snapshot => {
        const val = snapshot.val() || {};
        // merge server rooms into local
        const local = loadRooms();
        for(const code in val){
          local[code] = val[code];
        }
        // keep localRooms as union
        saveRooms(local);
        renderRoomList();
      });
      alert('Firebase connected (Realtime DB). Rooms will sync.');
    } catch (err) {
      console.error(err);
      alert('Firebase connect failed: ' + err.message);
    }
  }

  async function pushRoomToFirebase(code, roomObj){
    if(!useFirebase || !db) return;
    await db.ref('ludo_rooms/' + code).set(roomObj);
  }
  async function pushChatToFirebase(code, chatArr){
    if(!useFirebase || !db) return;
    await db.ref('ludo_rooms/' + code + '/chat').set(chatArr);
  }
  async function pushStateToFirebase(code, state){
    if(!useFirebase || !db) return;
    await db.ref('ludo_rooms/' + code + '/state').set(state);
  }

  async function subscribeRoom(code){
    if(!useFirebase || !db) return;
    // listen for room changes and update local copy
    db.ref('ludo_rooms/' + code).on('value', snapshot => {
      const val = snapshot.val();
      if(!val) return;
      const local = loadRooms();
      local[code] = val;
      saveRooms(local);
      renderChat();
      drawBoard();
      $('statusMsg').innerText = `Room ${code} • Players: ${val.players ? val.players.join(', ') : ''}`;
    });
  }

  // Connect / Disconnect Firebase buttons
  $('connectFb').onclick = ()=>{
    const txt = $('fbConfig').value.trim();
    if(!txt) return alert('Paste Firebase config JSON first');
    let cfg = null;
    try { cfg = JSON.parse(txt); } catch(e){ return alert('Invalid JSON'); }
    // load compat SDK dynamically and then connect
    // add firebase compat script tag
    if(!window.firebase){
      const s = document.createElement('script');
      s.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
      s.onload = ()=> {
        const r = document.createElement('script');
        r.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
        r.onload = ()=> connectFirebaseFromConfig(cfg);
        document.head.appendChild(r);
      };
      document.head.appendChild(s);
    } else {
      connectFirebaseFromConfig(cfg);
    }
  };

  $('disconnectFb').onclick = ()=>{
    if(!useFirebase || !window.firebase) return alert('Not connected');
    // Very simple disconnect - reload page to remove listeners
    location.reload();
  };

  // Push local rooms to firebase root (useful when first connecting)
  async function pushAllLocalToFirebase(){
    if(!useFirebase || !db) return;
    const rooms = loadRooms();
    await db.ref('ludo_rooms').set(rooms);
  }

  // ========== Init ==========
  showUserInfo();
  renderRoomList();
  drawBoard();

  // keyboard send
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && document.activeElement === $('chatText')) $('sendMsg').click();
  });

  // Periodic sync local UI with storage (support multiple tabs)
  setInterval(()=>{ renderRoomList(); renderChat(); drawBoard(); }, 1200);

  </script>
</body>
</html>